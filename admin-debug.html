<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Debug — Viewer API</title>
<style>
  :root{--bg:#0f1117;--panel:#151826;--muted:#9397a1;--text:#e7e9ee;--border:#20263e}
  html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border)}
  main{padding:16px;display:grid;gap:12px}
  .panel{background:#121628;border:1px solid var(--border);border-radius:10px;padding:12px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,button{background:#0e1324;color:var(--text);border:1px solid #2a3150;border-radius:8px;padding:8px 10px}
  button{cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;min-width:900px;background:#0e1324}
  th,td{padding:8px 10px;border-bottom:1px solid #1a1f33;font-size:13px;vertical-align:top}
  th{position:sticky;top:0;background:#111833;text-align:left;z-index:1}
  pre{background:#0e1324;border:1px solid var(--border);border-radius:10px;padding:10px;max-height:300px;overflow:auto}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #3a3f57;border-radius:999px;font-size:12px;color:#cfd5ff;background:#141b33}
</style>
</head>
<body>
<header>
  <strong>Admin Debug</strong>
  <span id="status" class="muted">Pronto</span>
</header>
<main>
  <section class="panel">
    <div class="row">
      <div style="flex:1 1 520px">
        <label>Endpoint completo o relativo (p.es. <code>/admin/used-cards</code> oppure <code>https://api.malgax.com/admin/used-cards</code>)</label>
        <input id="endpoint" style="width:100%" placeholder="/admin/used-cards">
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btn-load">Carica</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btn-sample">Simula dati</button>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Parametri rapidi</label>
        <input id="p-kind" placeholder="kind (es. creature)">
      </div>
      <div>
        <label>&nbsp;</label>
        <input id="p-status" placeholder="status (all|pending|done)">
      </div>
      <div>
        <label>&nbsp;</label>
        <input id="p-user" placeholder="user">
      </div>
      <div>
        <label>&nbsp;</label>
        <input id="p-item" placeholder="item">
      </div>
      <div>
        <label>&nbsp;</label>
        <input id="p-limit" type="number" placeholder="limit" value="20">
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="muted">Tabella (mappaggio robusto)</div>
      <div id="count" class="muted"></div>
    </div>
    <div style="overflow:auto;border:1px solid var(--border);border-radius:10px">
      <table>
        <thead>
          <tr>
            <th>Quando</th>
            <th>Utente</th>
            <th>Carta</th>
            <th>Tipo</th>
            <th>Item ID</th>
            <th>Event ID</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="6" class="muted">Nessun dato</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="muted">Esito richiesta</div>
    </div>
    <div class="row" style="gap:16px">
      <div><strong>URL:</strong> <span id="dbg-url" class="muted"></span></div>
      <div><strong>Status:</strong> <span id="dbg-status" class="muted"></span></div>
    </div>
    <details open>
      <summary>Corpo risposta (grezzo)</summary>
      <pre id="dbg-body">(vuoto)</pre>
    </details>
    <details>
      <summary>Chiavi del primo record</summary>
      <pre id="dbg-keys">(vuoto)</pre>
    </details>
  </section>
</main>

<script>
const API_BASE = 'https://api.malgax.com';
const $ = s => document.querySelector(s);
const statusEl = $('#status'), rows = $('#rows'), countEl = $('#count');
const dbgUrl = $('#dbg-url'), dbgStatus = $('#dbg-status'), dbgBody = $('#dbg-body'), dbgKeys = $('#dbg-keys');

function toast(t){ statusEl.textContent = t; }
function esc(s){ return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function fmt(iso){ if(!iso) return ''; const d = new Date(iso); return isNaN(d)? String(iso) : d.toLocaleString(); }
function pick(o, keys, fb=''){ for(const k of keys){ if(o && o[k]!=null) return o[k]; } return fb; }
function ensureUrl(input){
  if(!input) return null;
  input = input.trim();
  if(!input) return null;
  if(input.startsWith('http')) return input;
  return API_BASE + input;
}
function normalizePayload(data){
  // Accetta: array diretto, {items:[...]}, {data:[...]}, {data:{items:[...]}}
  if(Array.isArray(data)) return data;
  if(data && Array.isArray(data.items)) return data.items;
  if(data && Array.isArray(data.data)) return data.data;
  if(data && data.data && Array.isArray(data.data.items)) return data.data.items;
  return [];
}

function render(items){
  rows.innerHTML = '';
  if(!items.length){
    rows.innerHTML = '<tr><td colspan="6" class="muted">Nessun dato</td></tr>';
    countEl.textContent = '';
    return;
  }
  const fr = document.createDocumentFragment();
  for(const r of items){
    const when = pick(r,['created_at','createdAt','timestamp','time','at','used_at','date']);
    const user = pick(r,['user_login','username','user','viewer','twitch_login','login','userName','player','name']);
    const card = pick(r,['item_name','card_name','name','item','title']);
    const kind = pick(r,['kind','type','card_type']);
    const itemId = pick(r,['item_id','card_id','itemId','cardId','reward_id','rewardId']);
    const eid = pick(r,['id','event_id','_id','eventId']);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(fmt(when))}</td>
      <td>${esc(user)}</td>
      <td>${esc(card)}</td>
      <td><span class="pill">${esc(kind)}</span></td>
      <td>${esc(itemId)}</td>
      <td>${esc(eid)}</td>
    `;
    fr.appendChild(tr);
  }
  rows.appendChild(fr);
  countEl.textContent = `(${items.length} record)`;
}

async function loadNow(){
  try{
    const base = ensureUrl($('#endpoint').value);
    const params = new URLSearchParams();
    if($('#p-kind').value)   params.set('kind',   $('#p-kind').value.trim());
    if($('#p-status').value) params.set('status', $('#p-status').value.trim());
    if($('#p-user').value)   params.set('user',   $('#p-user').value.trim());
    if($('#p-item').value)   params.set('item',   $('#p-item').value.trim());
    if($('#p-limit').value)  params.set('limit',  $('#p-limit').value.trim());

    if(!base){ toast('Inserisci un endpoint'); return; }
    const url = base + (params.toString()?('?'+params.toString()):'');
    dbgUrl.textContent = url;

    toast('Carico…');
    const res = await fetch(url, { credentials:'include', cache:'no-store' });
    dbgStatus.textContent = res.status + ' ' + res.statusText;
    let bodyText = await res.text();
    dbgBody.textContent = bodyText || '(vuoto)';
    if(!res.ok){ render([]); toast('Errore HTTP '+res.status); return; }

    let data;
    try{ data = JSON.parse(bodyText); }catch{ data = null; }
    if(!data){ render([]); toast('Risposta non-JSON'); return; }

    const items = normalizePayload(data);
    render(items);
    if(items[0]) dbgKeys.textContent = Object.keys(items[0]).join(', ');
    else dbgKeys.textContent = '(nessun elemento)';
    toast('OK');
  }catch(e){
    dbgStatus.textContent = 'ERRORE';
    dbgBody.textContent = String(e);
    render([]); toast('Errore: '+e.message);
  }
}

// Dati di prova locali
$('#btn-sample').onclick = ()=>{
  const sample = [
    { id: 101, created_at: new Date().toISOString(), user_login:'malgax', item_name:'Lee Sin', kind:'creature', item_id:123 },
    { event_id: 202, timestamp: new Date().toISOString(), username:'foo', title:'Fireball', type:'incantesimo', card_id:55 }
  ];
  dbgUrl.textContent = '(sample)';
  dbgStatus.textContent = '200 OK (fake)';
  dbgBody.textContent = JSON.stringify({ items: sample }, null, 2);
  dbgKeys.textContent = Object.keys(sample[0]).join(', ');
  render(sample);
};

$('#btn-load').onclick = loadNow;

// Scorciatoie utili:
//  - se non sai cosa mettere, prova /admin/used-cards o /inventory
document.addEventListener('DOMContentLoaded', ()=>{
  const q = new URLSearchParams(location.search);
  const ep = q.get('ep') || '/admin/used-cards';
  $('#endpoint').value = ep;
});
</script>
</body>
</html>
