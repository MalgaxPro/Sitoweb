<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malgax — Login & Classifica</title>
  <meta name="description" content="Accedi con Twitch e guarda la classifica punti delle sub sul canale di Malgax." />
  <style>
    :root { --twitch:#6441a5; --bg:#0f0f14; --card:#16161f; --text:#f4f4f7; --muted:#a4a4b5; --line:#2a2a36; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #1d1540 0%, #0f0f14 50%) no-repeat, var(--bg);
      color: var(--text);
      min-height:100vh; display:flex; justify-content:center; align-items:center; padding:24px;
    }

    /* ====== Layout 2 colonne ====== */
    .page {
      width:100%; max-width: 1200px;
      display:grid; grid-template-columns: 1fr 560px; gap:22px;
      align-items:start;
    }
    @media (max-width: 1100px) { .page { grid-template-columns: 1fr; } }

    /* ====== Colonna destra (login + leaderboard) ====== */
    .column { display:flex; flex-direction:column; gap:16px; }
    .topbar { display:flex; justify-content:flex-end; position:relative; z-index:3; }
    .btn {
      appearance:none; border:none; cursor:pointer; user-select:none;
      padding:10px 14px; border-radius:10px; font-weight:700; transition:transform .05s ease;
      display:inline-block; line-height:1; background:var(--twitch); color:#fff;
    }
    .btn:active { transform: translateY(1px); }
    .card {
      background: var(--card); border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .panel { padding: 18px; }
    .muted { color: var(--muted); font-size:14px; line-height:1.55; }
    .title { font-size:20px; margin:0 0 10px; }
    .frame { width:100%; height:65vh; border:0; background:#0c0c12; display:block; }
    @media (max-width: 720px) { .frame { height: 60vh; } }

    /* ====== Colonna sinistra (righe per categoria) ====== */
    .left-card {
      background: linear-gradient(135deg, rgba(100,65,165,.18), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:18px;
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    .cat {
      margin-bottom:18px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      padding:14px 14px 12px;
    }
    .cat-head { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
    .cat-title { margin:0; font-size:16px; letter-spacing:.2px; color:#eaeaf0; white-space:nowrap; }
    .cat-line {
      height:1px; background:var(--line); flex:1; border-radius:1px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }

    /* Righe carte: 5 per riga su desktop, 4/3/2 su schermi più piccoli */
    .cards-row {
      display:grid; gap:10px;
      grid-template-columns: repeat(5, 1fr);
    }
    @media (max-width: 980px) { .cards-row { grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 760px) { .cards-row { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 520px) { .cards-row { grid-template-columns: repeat(2, 1fr); } }

    /* Carta: altezza fissa + placeholder (così non vedi più “una linea”) */
    .card-item {
      height: 220px; /* REGOLA qui la dimensione della carta */
      background:#0c0c12;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      padding:8px; position:relative; overflow:hidden;
    }
    /* Placeholder visibile anche se l'immagine 404 */
    .card-item::before {
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        45deg,
        rgba(255,255,255,0.05), rgba(255,255,255,0.05) 10px,
        rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px
      );
    }
    .card-item img {
      position:relative; /* sopra al placeholder */
      max-width: 100%; max-height: 100%;
      width: auto; height: auto;
      object-fit: contain; /* non tagliare mai */
      display:block;
      z-index:1;
    }

    /* ====== Overlay popup ====== */
    .modal-mask { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9998; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal .box { width:min(420px, 92%); background:#11131a; border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:18px; color:#fff; text-align:center; }
    .modal .hint { color:#a4a4b5; font-size:13px; margin-top:8px; }

    /* iFrame di probing nascosto */
    .probe { position:absolute; width:1px; height:1px; opacity:0; pointer-events:none; }
  </style>
</head>
<body>

  <div class="page">
    <!-- ====== Colonna SINISTRA (categorie a righe) ====== -->
    <section class="left-card" aria-labelledby="left-title">
      <h2 id="left-title" class="title" style="margin-bottom:8px;">Preview carte</h2>

      <!-- Creature -->
      <div class="cat">
        <div class="cat-head">
          <h3 class="cat-title">Creature</h3>
          <div class="cat-line"></div>
        </div>
        <div class="cards-row">
          <figure class="card-item"><img src="/assets/img/creature%202.png" alt="Creatura 2" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%203.png" alt="Creatura 3" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%205.png" alt="Creatura 5" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%202.png" alt="Creatura 2" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%203.png" alt="Creatura 3" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
        </div>
      </div>

      <!-- Incantesimi -->
      <div class="cat">
        <div class="cat-head">
          <h3 class="cat-title">Incantesimi</h3>
          <div class="cat-line"></div>
        </div>
        <div class="cards-row">
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
        </div>
      </div>

      <!-- Istantanee -->
      <div class="cat" style="margin-bottom:0;">
        <div class="cat-head">
          <h3 class="cat-title">Istantanee</h3>
          <div class="cat-line"></div>
        </div>
        <div class="cards-row">
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea" loading="lazy" decoding="async" onerror="this.style.display='none'"/></figure>
        </div>
      </div>
    </section>

    <!-- ====== Colonna DESTRA (login + classifica) ====== -->
    <section class="column">
      <div class="topbar">
        <button id="btnAuth" class="btn" type="button">Accedi</button>
      </div>

      <div class="card panel">
        <h2 class="title">Classifica Punti</h2>
        <p class="muted" style="margin:0 0 12px">
          Ogni <strong>sub</strong> vale <strong>+1 punto</strong>, ogni <strong>gift</strong> vale <strong>+N punti</strong> al gifter.
        </p>
        <iframe
          class="frame"
          src="https://api.malgax.com/leaderboard.html"
          title="Classifica punti Malgax"
          loading="lazy"
          referrerpolicy="no-referrer"
        ></iframe>
      </div>
    </section>
  </div>

  <!-- Overlay popup -->
  <div id="mask" class="modal-mask"></div>
  <div id="modal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
    <div class="box">
      <div style="font-weight:700; margin-bottom:6px;">Accedi con Twitch</div>
      <div class="muted">Si sta aprendo una finestra per l’accesso…<br/>Se il popup è bloccato, <a id="loginLink" href="https://api.malgax.com/auth/twitch" style="color:#9cb3ff">clicca qui</a>.</div>
      <div class="hint">Al termine, questa finestra si chiuderà automaticamente.</div>
    </div>
  </div>

  <!-- iFrame nascosto: rileva stato login all’apertura pagina -->
  <iframe class="probe" src="https://api.malgax.com/profile.html?silent=1" title="probe" aria-hidden="true"></iframe>

  <script>
    /* ================= Config ================= */
    const API_ORIGIN = "https://api.malgax.com";
    const LOGIN_URL  = API_ORIGIN + "/auth/twitch?popup=1";
    const LOGOUT_URL = API_ORIGIN + "/logout?popup=1";

    /* ================= UI refs ================= */
    const btnAuth = document.getElementById('btnAuth');
    const mask    = document.getElementById('mask');
    const modal   = document.getElementById('modal');
    const loginLink = document.getElementById('loginLink');

    /* ================= Stato login ================= */
    let loggedIn = false;
    let authWin  = null;
    let monitor  = null;

    function setUI() { btnAuth.textContent = loggedIn ? 'Logout' : 'Accedi'; }
    setUI();

    /* ================= Overlay & popup helpers ================= */
    function centerSpecs(w, h) {
      const dualScreenLeft = window.screenLeft ?? screen.left;
      const dualScreenTop  = window.screenTop  ?? screen.top;
      const width  = window.innerWidth  || document.documentElement.clientWidth  || screen.width;
      const height = window.innerHeight || document.documentElement.clientHeight || screen.height;
      const left = dualScreenLeft + Math.max(0, (width - w) / 2);
      const top  = dualScreenTop  + Math.max(0, (height - h) / 2);
      return `scrollbars=yes,width=${w},height=${h},top=${top},left=${left}`;
    }
    function showModal(show) {
      mask.style.display  = show ? 'block' : 'none';
      modal.style.display = show ? 'flex' : 'none';
      modal.setAttribute('aria-hidden', show ? 'false' : 'true');
    }
    function openPopup(url) {
      showModal(true);
      authWin = window.open(url, 'authPopup', centerSpecs(640, 760));
      if (!authWin || authWin.closed) {
        showModal(false);
        window.location.href = url.replace('?popup=1', '');
        return;
      }
      monitor = setInterval(() => {
        if (authWin.closed) {
          clearInterval(monitor);
          showModal(false);
        }
      }, 300);
    }

    /* ================= Click: Login/Logout ================= */
    btnAuth.addEventListener('click', (e) => {
      e.preventDefault();
      if (!loggedIn) {
        loginLink.href = LOGIN_URL;
        openPopup(LOGIN_URL);
      } else {
        openPopup(LOGOUT_URL);
        const start = Date.now();
        const waitLogout = setInterval(() => {
          const closed = !authWin || authWin.closed;
          if (closed || Date.now() - start > 6000) {
            clearInterval(waitLogout);
            loggedIn = false;
            setUI();
          }
        }, 400);
      }
    });

    /* ================= Stato iniziale + update via postMessage ================= */
    const ALLOWED_ORIGIN = API_ORIGIN;
    window.addEventListener('message', (event) => {
      if (event.origin !== ALLOWED_ORIGIN) return;
      const data = event.data || {};
      if (data.type === 'login') {
        loggedIn = true;
        setUI();
        try { if (authWin && !authWin.closed) authWin.close(); } catch(e){}
        showModal(false);
      } else if (data.type === 'logout') {
        loggedIn = false;
        setUI();
        try { if (authWin && !authWin.closed) authWin.close(); } catch(e){}
        showModal(false);
      }
    });
  </script>
</body>
</html>
