<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malgax ‚Äî No Udyr challenge</title>
  <meta name="description" content="No Udyr challenge ‚Äî Accedi con Twitch, vedi le carte e la classifica punti." />
  <style>
    :root{
      --twitch:#6441a5; --bg:#0f0f14; --card:#16161f; --text:#f4f4f7; --muted:#a4a4b5; --line:#2a2a36;
      --cols-desktop: 5; --cols-tablet: 4; --cols-mobile: 2; --gap: 8px;
    }
    *{box-sizing:border-box}
    html,body{min-height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .hero{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));border-bottom:1px solid rgba(255,255,255,.08);padding:18px 24px}
    .hero-inner{max-width:1600px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:16px}
    .hero-title{margin:0;font-size: clamp(22px, 3vw, 34px);font-weight:800}
    .hero-actions{display:flex;align-items:center;gap:10px}
    .btn{appearance:none;border:0;cursor:pointer;padding:10px 14px;border-radius:10px;font-weight:700;background:var(--twitch);color:#fff}
    .btn.gray{background:#3a415a}
    .user-pill{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-weight:700}
    .user-name{max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .page{width:100%;max-width:1600px;margin:18px auto;padding:0 24px;display:grid;grid-template-columns:60% 40%;gap:24px}
    @media (max-width:1100px){ .page{grid-template-columns:1fr} }
    .left-card{background:linear-gradient(135deg, rgba(100,65,165,.18), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}
    .cat{margin-bottom:18px;background:#14141c;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:14px}
    .cat-head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .cat-title{margin:0;font-size:16px}
    .cat-line{height:1px;background:var(--line);flex:1}
    .tabs{display:flex;gap:10px;padding:10px;background:#14141c;border-bottom:1px solid rgba(255,255,255,.06)}
    .tab{padding:8px 12px;border-radius:10px;font-weight:700;font-size:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);cursor:pointer}
    .tab.is-active{background:rgba(100,65,165,.25);border-color:rgba(100,65,165,.55);box-shadow:0 0 0 3px rgba(100,65,165,.15) inset}
    .cards-row{display:grid;gap:var(--gap);grid-template-columns:repeat(var(--cols-desktop),1fr)}
    @media (max-width:980px){ .cards-row{grid-template-columns:repeat(var(--cols-tablet),1fr)} }
    @media (max-width:620px){ .cards-row{grid-template-columns:repeat(var(--cols-mobile),1fr)} }
    .card-item{position:relative;aspect-ratio: 2/3;background:#0c0c12;border:1px solid rgba(255,255,255,.12);border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;min-height:180px}
    .card-item img{width:100%;height:100%;object-fit:contain;display:block}
    .card{background:#16161f;border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden}
    .lb-tabs{display:flex;gap:10px;padding:10px;background:#14141c;border-bottom:1px solid rgba(255,255,255,.06)}
    .lb-tab{padding:8px 12px;border-radius:10px;font-weight:800;font-size:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);cursor:pointer}
    .lb-tab.is-active{background:rgba(100,65,165,.25);border-color:rgba(100,65,165,.55);box-shadow:0 0 0 3px rgba(100,65,165,.15) inset}
    .lb-head{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between}
    .lb-title{margin:0;font-size:16px;font-weight:800}
    .lb-panel{padding:12px 16px 16px}
    .lb-table{width:100%;border-collapse:collapse}
    .lb-table th,.lb-table td{padding:10px 8px;text-align:left;border-bottom:1px solid rgba(255,255,255,.06)}
    .lb-rank{width:70px;color:#cfcff0;font-variant-numeric:tabular-nums}
    .lb-user{font-weight:700}
    .lb-pts{text-align:right;font-variant-numeric:tabular-nums}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-inner">
      <h1 class="hero-title">üî• No Udyr challenge</h1>
      <div class="hero-actions" id="authbar">
        <!-- riempito da JS -->
        <button id="btnTwitch" class="btn" type="button">Login con Twitch</button>
      </div>
    </div>
  </header>

  <main class="page">
    <!-- SINISTRA: CARTE -->
    <section class="left-card" aria-labelledby="left-title">
      <h2 id="left-title" style="margin:0 0 8px">Carte</h2>

      <div class="cat" id="cat-creature">
        <div class="cat-head">
          <h3 class="cat-title">üêâ <strong>Champions</strong></h3>
          <div class="cat-line"></div>
        </div>
        <nav class="tabs" role="tablist" aria-label="Champions per costo" style="margin:4px 0 10px;">
          <button class="tab is-active" role="tab" aria-selected="true" aria-controls="crea-2" data-target="crea-2">Costo 2</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="crea-3" data-target="crea-3">Costo 3</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="crea-5" data-target="crea-5">Costo 5</button>
        </nav>
        <div class="cards-row" id="crea-2" role="tabpanel" aria-labelledby="Costo 2"></div>
        <div class="cards-row" id="crea-3" role="tabpanel" aria-labelledby="Costo 3" style="display:none"></div>
        <div class="cards-row" id="crea-5" role="tabpanel" aria-labelledby="Costo 5" style="display:none"></div>
      </div>

      <div class="cat" id="cat-spell">
        <div class="cat-head">
          <h3 class="cat-title">ü™Ñ Incantesimi</h3>
          <div class="cat-line"></div>
        </div>
        <div class="cards-row" id="spellsRow"></div>
      </div>

      <div class="cat" id="cat-instant" style="margin-bottom:0;">
        <div class="cat-head">
          <h3 class="cat-title">‚ö° Istantanee</h3>
          <div class="cat-line"></div>
        </div>
        <div class="cards-row" id="instantsRow"></div>
      </div>
    </section>

    <!-- DESTRA: REGOLE + CLASSIFICHE -->
    <section class="card">
      <div class="lb-tabs" role="tablist" aria-label="Seleziona classifica">
        <button class="lb-tab is-active" id="tabTop" data-url="/api/leaderboard/top" data-title="üèÜ Top Donator" role="tab" aria-selected="true">üèÜ Top Donator</button>
        <button class="lb-tab" id="tabUnspent" data-url="/api/leaderboard/unspent" data-title="ü™ô Punti non spesi" role="tab" aria-selected="false">ü™ô Punti non spesi</button>
      </div>
      <div class="lb-head">
        <h3 class="lb-title" id="lbTitle">üèÜ Top Donator</h3>
        <div class="muted">refresh 60s</div>
      </div>
      <div id="lbPanel" class="lb-panel"><div class="muted">Caricamento‚Ä¶</div></div>
    </section>
  </main>

<script>
const API = "https://api.malgax.com";

/* ========== AUTH: Twitch popup ========== */
const authbar = document.getElementById('authbar');

function renderLogged(login){
  authbar.innerHTML = `
    <span class="user-pill"><span class="user-name">${escapeHtml(login)}</span></span>
    <button id="btnLogout" class="btn gray" type="button">Logout</button>
  `;
  document.getElementById('btnLogout').onclick = () => {
    const url = API + '/logout?return_to=' + encodeURIComponent(location.href);
    location.href = url;
  };
}
function renderLogin(){
  authbar.innerHTML = `<button id="btnTwitch" class="btn" type="button">Login con Twitch</button>`;
  document.getElementById('btnTwitch').onclick = openTwitchPopup;
}

function openTwitchPopup(){
  const w = 520, h = 640;
  const y = window.top.outerHeight/2 + window.top.screenY - (h/2);
  const x = window.top.outerWidth/2  + window.top.screenX - (w/2);
  const url = API + '/auth/twitch?return_to=' + encodeURIComponent(location.href);
  const win = window.open(url, 'twitch_login', `width=${w},height=${h},left=${x},top=${y}`);
  // Poll /me finch√© non risulta loggato o il popup viene chiuso
  let tries = 0;
  const iv = setInterval(async ()=>{
    tries++;
    if (win && win.closed) { clearInterval(iv); checkMe(); return; }
    if (tries > 120) { clearInterval(iv); return; } // max ~2 minuti
    try{
      const me = await api('/me');
      if (me && me.login) { clearInterval(iv); renderLogged(me.login); }
    }catch{}
  }, 1000);
}

async function checkMe(){
  try{
    const me = await api('/me');
    if (me && me.login) renderLogged(me.login);
    else renderLogin();
  }catch{
    renderLogin();
  }
}

/* ========== UTILS ========== */
async function api(path, opts={}) {
  const res = await fetch(API+path, { credentials: 'include', ...opts });
  if (!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}
function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }

/* ========== TABS CHAMPIONS ========== */
(function(){
  const root  = document.getElementById('cat-creature');
  if(!root) return;
  const tabs  = root.querySelectorAll('.tabs .tab');
  const panes = root.querySelectorAll('[role="tabpanel"]');
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.remove('is-active'));
      btn.classList.add('is-active');
      panes.forEach(p=>p.style.display='none');
      const id = btn.dataset.target;
      const pane = root.querySelector('#'+id);
      if(pane) pane.style.display = '';
    });
  });
})();

/* ========== CARTE ========== */
const crea2El = document.getElementById('crea-2');
const crea3El = document.getElementById('crea-3');
const crea5El = document.getElementById('crea-5');
const spellsEl = document.getElementById('spellsRow');
const instantsEl = document.getElementById('instantsRow');

function makeCard(item){
  const fig = document.createElement('figure');
  fig.className = 'card-item';
  fig.title = item.name;
  const img = document.createElement('img');
  img.src = item.image_url || '';
  img.alt = item.name || '';
  fig.appendChild(img);
  return fig;
}
function kindKey(k){
  const kk = String(k||'').toLowerCase();
  if (kk.includes('crea')) return 'creature';
  if (kk.includes('spell') || kk.includes('incan')) return 'incantesimo';
  if (kk.includes('inst') || kk.includes('snap')) return 'istantanea';
  return kk;
}
async function loadCards(){
  // placeholder
  [crea2El,crea3El,crea5El,spellsEl,instantsEl].forEach(el=>{
    if(!el) return; el.innerHTML=''; for(let i=0;i<8;i++){ const ph=document.createElement('div'); ph.className='card-item'; ph.style.background='#0c0c12'; el.appendChild(ph); }
  });
  try{
    const { items=[] } = await api('/inventory');
    const creatures = items.filter(i=>kindKey(i.kind)==='creature');
    const spells    = items.filter(i=>kindKey(i.kind)==='incantesimo');
    const instants  = items.filter(i=>kindKey(i.kind)==='istantanea');

    [crea2El,crea3El,crea5El,spellsEl,instantsEl].forEach(el=>{ if(el) el.innerHTML=''; });

    const c2 = creatures.filter(i=>Number(i.cost_points)===2);
    const c3 = creatures.filter(i=>Number(i.cost_points)===3);
    const c5 = creatures.filter(i=>Number(i.cost_points)===5);

    c2.forEach(i=>crea2El.appendChild(makeCard(i)));
    c3.forEach(i=>crea3El.appendChild(makeCard(i)));
    c5.forEach(i=>crea5El.appendChild(makeCard(i)));

    if(!c2.length) crea2El.innerHTML = '<div class="muted" style="grid-column:1/-1;padding:10px;">Nessuna carta costo 2</div>';
    if(!c3.length) crea3El.innerHTML = '<div class="muted" style="grid-column:1/-1;padding:10px;">Nessuna carta costo 3</div>';
    if(!c5.length) crea5El.innerHTML = '<div class="muted" style="grid-column:1/-1;padding:10px;">Nessuna carta costo 5</div>';

    if(spells.length) spells.forEach(i=>spellsEl.appendChild(makeCard(i)));
    else spellsEl.innerHTML = '<div class="muted" style="grid-column:1/-1;padding:10px;">Nessun incantesimo</div>';

    if(instants.length) instants.forEach(i=>instantsEl.appendChild(makeCard(i)));
    else instantsEl.innerHTML = '<div class="muted" style="grid-column:1/-1;padding:10px;">Nessuna istantanea</div>';
  }catch(e){
    [crea2El,crea3El,crea5El,spellsEl,instantsEl].forEach(el=>{
      if(el) el.innerHTML = '<div class="muted" style="grid-column:1/-1;padding:10px;">Errore caricamento carte</div>';
    });
  }
}

/* ========== CLASSIFICHE ========== */
const lbPanel = document.getElementById('lbPanel');
const lbTitle = document.getElementById('lbTitle');
const tabTop = document.getElementById('tabTop');
const tabUnspent = document.getElementById('tabUnspent');
let lbTimer = 0;

async function renderLB(url){
  lbPanel.innerHTML = '<div class="muted">Caricamento‚Ä¶</div>';
  try{
    const json = await api(url);
    const arr = Array.isArray(json.items) ? json.items : json;
    if(!arr.length){ lbPanel.innerHTML = '<div class="muted">Nessun dato.</div>'; return; }
    const rows = arr.map((r,i)=>`
      <tr>
        <td class="lb-rank">${String(i+1).padStart(2,'0')}</td>
        <td class="lb-user">${(r.username||'Utente')}</td>
        <td class="lb-pts">${Number(r.total_points ?? r.unspent_points ?? r.points ?? 0)}</td>
      </tr>`).join('');
    lbPanel.innerHTML = `
      <table class="lb-table" aria-label="classifica">
        <thead><tr><th>#</th><th>Utente</th><th style="text-align:right">Punti</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  }catch(e){
    lbPanel.innerHTML = '<div class="muted">Errore nel caricamento.</div>';
  }
}
function activateLB(tabBtn){
  [tabTop, tabUnspent].forEach(b=>b.classList.remove('is-active'));
  tabBtn.classList.add('is-active');
  const title = tabBtn.getAttribute('data-title') || '';
  const url   = tabBtn.getAttribute('data-url') || '/api/leaderboard/top';
  lbTitle.textContent = title;
  renderLB(url);
  if (lbTimer) clearInterval(lbTimer);
  lbTimer = setInterval(()=>renderLB(url), 60000);
}
tabTop.addEventListener('click', ()=> activateLB(tabTop));
tabUnspent.addEventListener('click', ()=> activateLB(tabUnspent));

/* ========== START ========== */
checkMe();
loadCards();
activateLB(tabTop);
</script>
</body>
</html>
