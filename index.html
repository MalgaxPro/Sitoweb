<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malgax ‚Äî Login & Classifica</title>
  <meta name="description" content="Accedi con Twitch e guarda la classifica punti delle sub sul canale di Malgax." />
  <style>
    :root{
      --twitch:#6441a5; --bg:#0f0f14; --card:#16161f; --text:#f4f4f7; --muted:#a4a4b5; --line:#2a2a36;
      --cols-desktop: 5;   /* carte per riga (desktop) */
      --cols-tablet: 4;
      --cols-mobile: 2;
      --gap: 8px;          /* spazio tra carte */
      --ratio-w: 2;        /* immagini 1024x1536 => 2:3 */
      --ratio-h: 3;
    }
    *{box-sizing:border-box}
    html,body{min-height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #1d1540 0%, #0f0f14 50%) no-repeat, var(--bg);
      color:var(--text);
      /* üîß rimosso il flex centering che ‚Äúnascondeva‚Äù la parte alta */
      overflow-x:hidden;
    }

    /* ===== Layout 60% / 40% ===== */
    .page{
      width:100%; max-width:1600px;
      margin:24px auto;             /* centra orizzontalmente e d√† spazio dall‚Äôalto */
      padding:0 24px;
      display:grid; grid-template-columns: 60% 40%; gap:24px; align-items:start;
    }
    @media (max-width:1100px){ .page{ grid-template-columns:1fr } }

    /* ===== Colonna destra (login + leaderboard) ===== */
    .column{ display:flex; flex-direction:column; gap:16px }
    .topbar{ display:flex; justify-content:flex-end; position:sticky; top:0; z-index:5; padding-bottom:8px; background:transparent }
    .btn{
      appearance:none; border:0; cursor:pointer; user-select:none;
      padding:10px 14px; border-radius:10px; font-weight:700; background:var(--twitch); color:#fff;
    }
    .card{ background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,.25); overflow:hidden }
    .panel{ padding:18px }
    .muted{ color:var(--muted); font-size:14px; line-height:1.55 }
    .title{ font-size:20px; margin:0 0 10px }
    .frame{ width:100%; height:65vh; border:0; background:#0c0c12; display:block }
    @media (max-width:720px){ .frame{ height:60vh } }

    /* ===== Colonna sinistra (categorie) ===== */
    .left-card{
      background:linear-gradient(135deg, rgba(100,65,165,.18), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px; box-shadow:0 10px 28px rgba(0,0,0,.35)
    }
    .cat{ margin-bottom:18px; background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:14px }
    .cat-head{ display:flex; align-items:center; gap:10px; margin-bottom:12px }
    .cat-title{ margin:0; font-size:16px; color:#eaeaf0 }
    .cat-line{ height:1px; background:var(--line); flex:1; border-radius:1px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.02) }

    /* 2 righe piene ‚Äî 10 carte totali (5x2) su desktop */
    .cards-row{
      display:grid; gap: var(--gap);
      grid-template-columns: repeat(var(--cols-desktop), 1fr);
    }
    @media (max-width:980px){ .cards-row{ grid-template-columns: repeat(var(--cols-tablet), 1fr) } }
    @media (max-width:620px){ .cards-row{ grid-template-columns: repeat(var(--cols-mobile), 1fr) } }

    .card-item{
      position:relative;
      aspect-ratio: calc(var(--ratio-w) / var(--ratio-h)); /* 2:3 */
      background:#0c0c12; border:1px solid rgba(255,255,255,.12); border-radius:12px;
      overflow:hidden; display:flex; align-items:center; justify-content:center; padding:0;
      min-height: 180px; /* evita carte minuscole su schermi stretti */
    }
    .card-item img{
      width:100%; height:100%; object-fit:contain; display:block; image-rendering:auto;
    }

    /* iFrame di probing nascosto */
    .probe{ position:absolute; width:1px; height:1px; opacity:0; pointer-events:none }

    /* Overlay popup */
    .modal-mask{display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9998}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999}
    .modal .box{ width:min(420px, 92%); background:#11131a; border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:18px; color:#fff; text-align:center }
    .modal .hint{ color:#a4a4b5; font-size:13px; margin-top:8px }
  </style>
</head>
<body>

  <main class="page">
    <!-- ===== Colonna SINISTRA (60%) ===== -->
    <section class="left-card" aria-labelledby="left-title">
      <h2 id="left-title" class="title" style="margin-bottom:8px;">Preview carte</h2>

      <!-- Creature -->
      <div class="cat">
        <div class="cat-head"><h3 class="cat-title">Creature</h3><div class="cat-line"></div></div>
        <div class="cards-row">
          <figure class="card-item"><img src="/assets/img/creature%202.png" alt="Creatura 2"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%203.png" alt="Creatura 3"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%205.png" alt="Creatura 5"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%202.png" alt="Creatura 2"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%203.png" alt="Creatura 3"/></figure>

          <figure class="card-item"><img src="/assets/img/creature%205.png" alt="Creatura 5"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%202.png" alt="Creatura 2"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%203.png" alt="Creatura 3"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%205.png" alt="Creatura 5"/></figure>
          <figure class="card-item"><img src="/assets/img/creature%202.png" alt="Creatura 2"/></figure>
        </div>
      </div>

      <!-- Incantesimi -->
      <div class="cat">
        <div class="cat-head"><h3 class="cat-title">Incantesimi</h3><div class="cat-line"></div></div>
        <div class="cards-row">
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo"/></figure>

          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo"/></figure>
          <figure class="card-item"><img src="/assets/img/incantesimi.png" alt="Incantesimo"/></figure>
        </div>
      </div>

      <!-- Istantanee -->
      <div class="cat" style="margin-bottom:0;">
        <div class="cat-head"><h3 class="cat-title">Istantanee</h3><div class="cat-line"></div></div>
        <div class="cards-row">
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea"/></figure>

          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea"/></figure>
          <figure class="card-item"><img src="/assets/img/istantanea.png" alt="Istantanea"/></figure>
        </div>
      </div>
    </section>

    <!-- ===== Colonna DESTRA (40%) ===== -->
    <section class="column">
      <div class="topbar"><button id="btnAuth" class="btn" type="button">Accedi</button></div>
      <div class="card panel">
        <h2 class="title">Classifica Punti</h2>
        <p class="muted" style="margin:0 0 12px">Ogni <strong>sub</strong> vale <strong>+1 punto</strong>, ogni <strong>gift</strong> vale <strong>+N punti</strong> al gifter.</p>
        <iframe class="frame" src="https://api.malgax.com/leaderboard.html" title="Classifica punti Malgax" loading="lazy" referrerpolicy="no-referrer"></iframe>
      </div>
    </section>
  </main>

  <!-- Overlay popup -->
  <div id="mask" class="modal-mask"></div>
  <div id="modal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
    <div class="box">
      <div style="font-weight:700; margin-bottom:6px;">Accedi con Twitch</div>
      <div class="muted">Si sta aprendo una finestra per l‚Äôaccesso‚Ä¶<br/>Se il popup √® bloccato, <a id="loginLink" href="https://api.malgax.com/auth/twitch" style="color:#9cb3ff">clicca qui</a>.</div>
      <div class="hint">Al termine, questa finestra si chiuder√† automaticamente.</div>
    </div>
  </div>

  <!-- probe stato login -->
  <iframe class="probe" src="https://api.malgax.com/profile.html?silent=1" title="probe" aria-hidden="true"></iframe>

  <script>
    const API_ORIGIN="https://api.malgax.com";
    const LOGIN_URL =API_ORIGIN+"/auth/twitch?popup=1";
    const LOGOUT_URL=API_ORIGIN+"/logout?popup=1";

    const btnAuth=document.getElementById('btnAuth');
    const mask=document.getElementById('mask');
    const modal=document.getElementById('modal');
    const loginLink=document.getElementById('loginLink');

    let loggedIn=false, authWin=null, monitor=null;
    const setUI=()=>btnAuth.textContent=loggedIn?'Logout':'Accedi'; setUI();

    function centerSpecs(w,h){
      const l=window.screenLeft??screen.left, t=window.screenTop??screen.top;
      const W=window.innerWidth||document.documentElement.clientWidth||screen.width;
      const H=window.innerHeight||document.documentElement.clientHeight||screen.height;
      return `scrollbars=yes,width=${w},height=${h},top=${t+Math.max(0,(H-h)/2)},left=${l+Math.max(0,(W-w)/2)}`;
    }
    function showModal(v){ mask.style.display=v?'block':'none'; modal.style.display=v?'flex':'none'; modal.setAttribute('aria-hidden',v?'false':'true'); }
    function openPopup(url){
      showModal(true);
      authWin=window.open(url,'authPopup',centerSpecs(640,760));
      if(!authWin||authWin.closed){ showModal(false); location.href=url.replace('?popup=1',''); return; }
      monitor=setInterval(()=>{ if(authWin.closed){ clearInterval(monitor); showModal(false); } },300);
    }

    btnAuth.addEventListener('click',(e)=>{
      e.preventDefault();
      if(!loggedIn){ loginLink.href=LOGIN_URL; openPopup(LOGIN_URL); }
      else{
        openPopup(LOGOUT_URL);
        const start=Date.now();
        const wait=setInterval(()=>{ const closed=!authWin||authWin.closed; if(closed||Date.now()-start>6000){ clearInterval(wait); loggedIn=false; setUI(); } },400);
      }
    });

    window.addEventListener('message',(ev)=>{
      if(ev.origin!=="https://api.malgax.com") return;
      const d=ev.data||{};
      if(d.type==='login'){ loggedIn=true; setUI(); try{ if(authWin&&!authWin.closed) authWin.close(); }catch(e){} showModal(false); }
      if(d.type==='logout'){ loggedIn=false; setUI(); try{ if(authWin&&!authWin.closed) authWin.close(); }catch(e){} showModal(false); }
    });
  </script>
</body>
</html>
