<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amministrazione — Eventi</title>
  <style>
    :root{
      --bg:#0f1117; --panel:#151826; --muted:#9397a1; --text:#e7e9ee;
      --acc:#5b8cff; --grid:#1b2033; --radius:14px;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid #22263a;background:linear-gradient(180deg,#12172a,transparent)}
    header h1{font-size:18px;margin:0}
    header .badge{font-size:12px;padding:2px 8px;border:1px solid #3a3f57;border-radius:999px;color:var(--muted)}
    main{padding:18px;display:grid;gap:14px}
    .panel{background:var(--panel);border:1px solid #20263e;border-radius:var(--radius);padding:14px}
    .filters{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:10px}
    .filters label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    input,button{background:#0e1324;color:var(--text);border:1px solid #2a3150;border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .actions{display:flex;gap:10px}
    .table{overflow:auto;border-radius:12px;border:1px solid #20263e}
    table{width:100%;border-collapse:collapse;min-width:900px;background:#0e1324}
    th,td{padding:10px 12px;border-bottom:1px solid #1a1f33;font-size:13px;vertical-align:top}
    th{position:sticky;top:0;background:#111833;text-align:left}
    tr:hover td{background:#0f1731}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #3a3f57;border-radius:999px;font-size:12px;color:#cfd5ff;background:#141b33}
    .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .right{margin-left:auto}
    .json{font-family:ui-monospace,monospace;white-space:pre-wrap;word-break:break-word}
    .status{font-size:12px;color:var(--muted)}
    .ok{color:#9cffbd}
    .warn{color:#ffd27a}
    .err{color:#ff9b9b}
    details.debug{margin-top:8px}
    details.debug summary{cursor:pointer;color:#9aa0ff}
    pre{background:#0e1324;border:1px solid #20263e;border-radius:10px;padding:10px;max-height:240px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <h1>Amministrazione</h1>
    <span class="badge">Eventi</span>
    <div class="right status" id="status">Verifica accesso…</div>
  </header>

  <main>
    <section class="panel">
      <div id="authbar" class="status">Controllo login…</div>

      <details class="debug">
        <summary>Debug login (/me)</summary>
        <div style="margin-top:8px">
          <button id="btn-me">Ricarica /me</button>
          <pre id="me-dump">(vuoto)</pre>
        </div>
      </details>

      <div class="filters" style="margin-top:10px">
        <label>Tipo evento <input id="f-type" disabled></label>
        <label>Utente <input id="f-user" disabled></label>
        <label>Dal <input id="f-from" type="datetime-local" disabled></label>
        <label>Al <input id="f-to" type="datetime-local" disabled></label>
        <label>Limite <input id="f-limit" type="number" value="50" disabled></label>
        <label>Endpoint
          <input id="f-endpoint" placeholder="/events (quando lo crei). Per test: /inventory o /api/leaderboard/top" disabled>
        </label>
      </div>
      <div class="row" style="margin-top:10px;align-items:center">
        <div class="actions">
          <button id="btn-load" disabled>Cerca</button>
          <button id="btn-auto" disabled>Auto refresh: OFF</button>
          <button id="btn-export" disabled>Esporta CSV</button>
          <button id="btn-clear" disabled>Pulisci filtri</button>
        </div>
        <div class="right pagination">
          <button id="btn-prev" disabled>&larr; Prev</button>
          <span id="page-indicator" class="muted">Pagina 1</span>
          <button id="btn-next" disabled>Next &rarr;</button>
        </div>
      </div>
    </section>

    <section class="panel table">
      <table>
        <thead>
          <tr>
            <th>Quando</th><th>Tipo</th><th>Dettagli</th><th>Utente</th><th>Origine</th><th>ID</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="6" class="muted">Nessun dato</td></tr>
        </tbody>
      </table>
    </section>
  </main>

<script>
/* ====================== CONFIG ====================== */
const API_BASE   = 'https://api.malgax.com';
const ME_ENDPOINT= '/me';
const ADMIN_LOGIN= 'malgax';

// Se vuoi il POPUP, metti true. Di default usiamo redirect a pagina intera (più affidabile).
let USE_POPUP = false;

/* ====================== STATO ====================== */
let page=0,pageSize=50,autoTimer=null,eventsCache=[],isAdmin=false,popupRef=null;

/* ====================== DOM ====================== */
const $=s=>document.querySelector(s);
const status=$('#status'),authbar=$('#authbar'),rows=$('#rows');
const fType=$('#f-type'),fUser=$('#f-user'),fFrom=$('#f-from'),fTo=$('#f-to'),
      fLimit=$('#f-limit'),fEndpoint=$('#f-endpoint');
const btnLoad=$('#btn-load'),btnAuto=$('#btn-auto'),btnExport=$('#btn-export'),
      btnClear=$('#btn-clear'),btnPrev=$('#btn-prev'),btnNext=$('#btn-next'),
      pageInd=$('#page-indicator'),btnMe=$('#btn-me'),meDump=$('#me-dump');

/* ====================== URL LOGIN/LOGOUT ====================== */
const PROFILE_URL = new URL(location.origin + '/profile.html'); // pagina che chiude popup (se esiste)
const AUTH_LOGIN_URL  = USE_POPUP
  ? (API_BASE + '/auth/twitch?return_to=' + encodeURIComponent(PROFILE_URL.href))
  : (API_BASE + '/auth/twitch?return_to=' + encodeURIComponent(location.href));
const AUTH_LOGOUT_URL = API_BASE + '/logout?return_to=' + encodeURIComponent(location.href);

/* ====================== UTIL ====================== */
function toast(msg,cls=''){status.innerHTML=`<span class="${cls}">${msg}</span>`;}
function setSearchEnabled(on){
  [fType,fUser,fFrom,fTo,fLimit,fEndpoint,btnLoad,btnAuto,btnExport,btnClear,btnPrev,btnNext].forEach(el=>el.disabled=!on);
}
function esc(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
function fmtDate(iso){if(!iso)return'';const d=new Date(iso);return isNaN(d)?String(iso):d.toLocaleString();}

/* ====================== AUTH UI ====================== */
function getLoginFromMe(me){
  // Prova varie forme comuni
  return (me?.login
      || me?.username
      || me?.name
      || me?.display_name
      || me?.user?.login
      || me?.data?.login
      || me?.data?.user?.login
      || '').toString().toLowerCase();
}
function renderAuth(me){
  authbar.innerHTML='';
  const who=getLoginFromMe(me);
  if(who){
    authbar.innerHTML=
      `<span class="status ok">Loggato come ${esc(who)}</span>
       <button id="btn-out">Logout</button>`;
    $('#btn-out').onclick=()=>{ location.href = AUTH_LOGOUT_URL; };
    isAdmin=(who===ADMIN_LOGIN);
    setSearchEnabled(isAdmin);
    toast(isAdmin?'Accesso admin OK (malgax)':'Loggato, ma non autorizzato','ok');
  }else{
    authbar.innerHTML=
      `<span class="status">Non loggato</span>
       <button id="btn-in">Login con Twitch</button>`;
    $('#btn-in').onclick=()=>openLogin();
    isAdmin=false; setSearchEnabled(false);
  }
}
async function checkMe(showDump=false){
  try{
    const res=await fetch(API_BASE+ME_ENDPOINT,{credentials:'include',cache:'no-store'});
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    const me=await res.json();
    renderAuth(me);
    if(showDump){ meDump.textContent = JSON.stringify(me,null,2); }
  }catch(err){
    renderAuth(null);
    if(showDump){ meDump.textContent = 'ERRORE: '+err.message; }
  }
}

/* ====================== LOGIN FLOW ====================== */
function openLogin(){
  if(!USE_POPUP){
    // modalità semplice e affidabile: redirect nella stessa pagina
    location.href = AUTH_LOGIN_URL;
    return;
  }
  // POPUP mode
  const w=520,h=680,y=window.top.outerHeight/2+window.top.screenY-h/2,x=window.top.outerWidth/2+window.top.screenX-w/2;
  popupRef=window.open(AUTH_LOGIN_URL,'login_twitch',
    `toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=${w},height=${h},top=${y},left=${x}`);
  if(!popupRef||popupRef.closed){ location.href = AUTH_LOGIN_URL; return; }
  const poll=setInterval(()=>{ if(!popupRef||popupRef.closed){ clearInterval(poll); checkMe(true); } },500);
}
window.addEventListener('focus',()=>checkMe());
window.addEventListener('message',()=>checkMe(true));
btnMe.onclick=()=>checkMe(true);

/* ====================== TABELLA ====================== */
function currentEndpoint(){
  const m=(fEndpoint.value||'').trim();
  if(!m){toast('Scrivi un endpoint (es. /inventory, /api/leaderboard/top, /events)','warn');return null;}
  return m.startsWith('http')?m:(API_BASE+m);
}
function buildQuery(){
  pageSize=Number(fLimit.value||50)||50;
  return {
    limit:pageSize, offset:page*pageSize,
    type:(fType.value||'').trim()||undefined,
    user:(fUser.value||'').trim()||undefined,
    from:fFrom.value?new Date(fFrom.value).toISOString():undefined,
    to:fTo.value?new Date(fTo.value).toISOString():undefined,
  };
}
function renderTable(items){
  rows.innerHTML='';
  if(!items?.length){rows.innerHTML='<tr><td colspan="6" class="muted">Nessun dato</td></tr>';return;}
  const fr=document.createDocumentFragment();
  for(const ev of items){
    const tr=document.createElement('tr');
    const when=ev.created_at||ev.timestamp||ev.time||ev.at||null;
    const type=ev.type||ev.event_type||ev.kind||'—';
    const origin=ev.source||ev.origin||ev.provider||'—';
    const uid=ev.id||ev.event_id||ev._id||'—';
    const user=ev.user_login||ev.username||ev.user||ev.viewer||ev.twitch_login||'—';
    const det=Object.assign({},ev);
    for(const k of ['raw','payload','body']) if(det[k]&&typeof det[k]==='string'&&det[k].length>400) det[k]=det[k].slice(0,400)+'…';
    tr.innerHTML=
      `<td>${esc(fmtDate(when))}</td>
       <td><span class="pill">${esc(type)}</span></td>
       <td class="json">${esc(JSON.stringify(det,null,2))}</td>
       <td>${esc(user)}</td>
       <td class="muted">${esc(origin)}</td>
       <td class="muted">${esc(uid)}</td>`;
    fr.appendChild(tr);
  }
  rows.appendChild(fr);
}

/* ====================== CARICAMENTO ====================== */
async function load(){
  if(!isAdmin){toast('Solo malgax può cercare','err');return;}
  const url=currentEndpoint(); if(!url)return;
  const qs=new URLSearchParams(buildQuery()).toString();
  try{
    toast('Caricamento…');
    const res=await fetch(url+(qs?('?'+qs):''),{credentials:'include',cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json();
    const items=Array.isArray(data)?data:(data.items||[]);
    eventsCache=items;
    renderTable(items);
    toast(`Caricati ${items.length} elemento/i`,'ok');
  }catch(e){ renderTable([]); toast('Errore: '+e.message,'err'); }
}

/* ====================== WIRE ====================== */
btnLoad.onclick=()=>{page=0;load();};
btnClear.onclick=()=>{fType.value=fUser.value=fFrom.value=fTo.value='';};
[fType,fUser,fFrom,fTo,fLimit,fEndpoint].forEach(el=>el.addEventListener('keydown',e=>{
  if(e.key==='Enter' && isAdmin){ page=0; load(); }
}));

// Avvio
checkMe(true);
</script>
</body>
</html>
