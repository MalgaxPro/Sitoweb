<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amministrazione — Eventi</title>
  <style>
    :root{
      --bg:#0f1117; --panel:#151826; --muted:#9397a1; --text:#e7e9ee;
      --acc:#5b8cff; --grid:#1b2033; --radius:14px;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid #22263a;background:linear-gradient(180deg,#12172a,transparent)}
    header h1{font-size:18px;margin:0}
    header .badge{font-size:12px;padding:2px 8px;border:1px solid #3a3f57;border-radius:999px;color:var(--muted)}
    main{padding:18px;display:grid;gap:14px}
    .panel{background:var(--panel);border:1px solid #20263e;border-radius:var(--radius);padding:14px}
    .filters{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:10px}
    .filters label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    input,button{background:#0e1324;color:var(--text);border:1px solid #2a3150;border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .actions{display:flex;gap:10px}
    .table{overflow:auto;border-radius:12px;border:1px solid #20263e}
    table{width:100%;border-collapse:collapse;min-width:900px;background:#0e1324}
    th,td{padding:10px 12px;border-bottom:1px solid #1a1f33;font-size:13px;vertical-align:top}
    th{position:sticky;top:0;background:#111833;text-align:left}
    tr:hover td{background:#0f1731}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #3a3f57;border-radius:999px;font-size:12px;color:#cfd5ff;background:#141b33}
    .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .right{margin-left:auto}
    .json{font-family:ui-monospace,monospace;white-space:pre-wrap;word-break:break-word}
    .status{font-size:12px;color:var(--muted)}
    .ok{color:#9cffbd}
    .warn{color:#ffd27a}
    .err{color:#ff9b9b}
  </style>
</head>
<body>
  <header>
    <h1>Amministrazione</h1>
    <span class="badge">Eventi</span>
    <div class="right status" id="status">Verifica accesso…</div>
  </header>

  <main>
    <section class="panel">
      <div id="authbar" class="status">Controllo login…</div>
      <div class="filters" style="margin-top:10px">
        <label>Tipo evento <input id="f-type" disabled></label>
        <label>Utente <input id="f-user" disabled></label>
        <label>Dal <input id="f-from" type="datetime-local" disabled></label>
        <label>Al <input id="f-to" type="datetime-local" disabled></label>
        <label>Limite <input id="f-limit" type="number" value="50" disabled></label>
        <label>Endpoint <input id="f-endpoint" placeholder="/events" disabled></label>
      </div>
      <div class="row" style="margin-top:10px;align-items:center">
        <div class="actions">
          <button id="btn-load" disabled>Cerca</button>
          <button id="btn-auto" disabled>Auto refresh: OFF</button>
          <button id="btn-export" disabled>Esporta CSV</button>
          <button id="btn-clear" disabled>Pulisci filtri</button>
        </div>
        <div class="right pagination">
          <button id="btn-prev" disabled>&larr; Prev</button>
          <span id="page-indicator" class="muted">Pagina 1</span>
          <button id="btn-next" disabled>Next &rarr;</button>
        </div>
      </div>
    </section>

    <section class="panel table">
      <table>
        <thead>
          <tr>
            <th>Quando</th><th>Tipo</th><th>Dettagli</th><th>Utente</th><th>Origine</th><th>ID</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="6" class="muted">Nessun dato</td></tr>
        </tbody>
      </table>
    </section>
  </main>

<script>
const API_BASE = 'https://api.malgax.com';
const ME_ENDPOINT = '/me';
const ADMIN_LOGIN = 'malgax';

let page=0,pageSize=50,autoTimer=null,eventsCache=[],isAdmin=false,popupRef=null;

const $=s=>document.querySelector(s);
const status=$('#status'),authbar=$('#authbar'),rows=$('#rows');
const fType=$('#f-type'),fUser=$('#f-user'),fFrom=$('#f-from'),fTo=$('#f-to'),
      fLimit=$('#f-limit'),fEndpoint=$('#f-endpoint');
const btnLoad=$('#btn-load'),btnAuto=$('#btn-auto'),btnExport=$('#btn-export'),
      btnClear=$('#btn-clear'),btnPrev=$('#btn-prev'),btnNext=$('#btn-next'),
      pageInd=$('#page-indicator');

const PROFILE_URL=new URL(location.origin+'/profile.html');
const AUTH_LOGIN_URL=API_BASE+'/auth/twitch?return_to='+encodeURIComponent(PROFILE_URL.href);
const AUTH_LOGOUT_URL=API_BASE+'/logout?return_to='+encodeURIComponent(location.href);

function toast(msg,cls=''){status.innerHTML=`<span class="${cls}">${msg}</span>`;}
function setSearchEnabled(on){
  [fType,fUser,fFrom,fTo,fLimit,fEndpoint,btnLoad,btnAuto,btnExport,btnClear,btnPrev,btnNext].forEach(el=>el.disabled=!on);
}
function renderAuth(me){
  authbar.innerHTML='';
  if(me?.login){
    const who=(me.login||'').toLowerCase();
    authbar.innerHTML=`<span class="status ok">Loggato come ${who}</span>
                       <button onclick="location.href='${AUTH_LOGOUT_URL}'">Logout</button>`;
    isAdmin=(who===ADMIN_LOGIN); setSearchEnabled(isAdmin);
    toast(isAdmin?'Accesso admin OK':'Non autorizzato','ok');
  }else{
    authbar.innerHTML=`<span class="status">Non loggato</span>
                       <button onclick="openLoginPopup()">Login con Twitch</button>`;
    isAdmin=false; setSearchEnabled(false);
  }
}
async function checkMe(){
  try{
    const res=await fetch(API_BASE+ME_ENDPOINT,{credentials:'include'});
    if(!res.ok) throw new Error();
    renderAuth(await res.json());
  }catch{renderAuth(null);}
}
function openLoginPopup(){
  const w=520,h=680,y=window.top.outerHeight/2+window.top.screenY-h/2,x=window.top.outerWidth/2+window.top.screenX-w/2;
  popupRef=window.open(AUTH_LOGIN_URL,'login_twitch',
    `toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=${w},height=${h},top=${y},left=${x}`);
  if(!popupRef||popupRef.closed){location.href=AUTH_LOGIN_URL;return;}
  const poll=setInterval(()=>{if(!popupRef||popupRef.closed){clearInterval(poll);checkMe();}},500);
}
window.addEventListener('focus',()=>checkMe());
window.addEventListener('message',()=>checkMe());

function currentEndpoint(){
  const m=(fEndpoint.value||'').trim();
  if(!m){toast('Scrivi un endpoint (es. /inventory, /api/leaderboard/top, /events)','warn');return null;}
  return m.startsWith('http')?m:(API_BASE+m);
}
function buildQuery(){
  pageSize=Number(fLimit.value||50);
  return {limit:pageSize,offset:page*pageSize,
          type:fType.value||undefined,user:fUser.value||undefined,
          from:fFrom.value?new Date(fFrom.value).toISOString():undefined,
          to:fTo.value?new Date(fTo.value).toISOString():undefined};
}
function renderTable(items){
  rows.innerHTML='';
  if(!items?.length){rows.innerHTML='<tr><td colspan=6 class=muted>Nessun dato</td></tr>';return;}
  items.forEach(ev=>{
    const when=ev.created_at||ev.timestamp, type=ev.type||ev.event_type||'—',
          user=ev.user_login||ev.username||'—', origin=ev.source||'—', uid=ev.id||'—';
    const det=JSON.stringify(ev).slice(0,200);
    rows.innerHTML+=`<tr><td>${when||''}</td><td><span class=pill>${type}</span></td>
                     <td class=json>${det}</td><td>${user}</td><td>${origin}</td><td>${uid}</td></tr>`;
  });
}
async function load(){
  if(!isAdmin){toast('Solo malgax può cercare','err');return;}
  const url=currentEndpoint(); if(!url)return;
  try{
    const res=await fetch(url+('?'+new URLSearchParams(buildQuery())),{credentials:'include'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json(),items=Array.isArray(data)?data:(data.items||[]);
    eventsCache=items; renderTable(items);
    toast(`Caricati ${items.length} evento/i`,'ok');
  }catch(e){toast('Errore: '+e.message,'err');}
}
btnLoad.onclick=()=>{page=0;load();};
btnClear.onclick=()=>{fType.value=fUser.value=fFrom.value=fTo.value='';};
checkMe();
</script>
</body>
</html>
