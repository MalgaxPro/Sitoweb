<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amministrazione — Carte usate</title>
  <style>
    :root{
      --bg:#0f1117; --panel:#151826; --muted:#9397a1; --text:#e7e9ee; --acc:#5b8cff; --radius:14px;
      --border:#20263e; --panel2:#0e1324;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#12172a,transparent)}
    header h1{font-size:18px;margin:0}
    header .badge{font-size:12px;padding:2px 8px;border:1px solid #3a3f57;border-radius:999px;color:var(--muted)}
    main{padding:18px;display:grid;gap:14px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
    .filters{display:grid;grid-template-columns:repeat(7,minmax(120px,1fr));gap:10px}
    .filters label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    input,select,button{background:var(--panel2);color:var(--text);border:1px solid #2a3150;border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#111733;color:#cfd5ff;cursor:pointer}
    .tab.active{background:#1a2448;border-color:#2a3a7a}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .actions{display:flex;gap:10px}
    .table{overflow:auto;border-radius:12px;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;min-width:1000px;background:var(--panel2)}
    th,td{padding:10px 12px;border-bottom:1px solid #1a1f33;font-size:13px;vertical-align:top}
    th{position:sticky;top:0;background:#111833;text-align:left;z-index:1}
    tr:hover td{background:#0f1731}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #3a3f57;border-radius:999px;font-size:12px;color:#cfd5ff;background:#141b33}
    .status{font-size:12px;color:var(--muted)}
    .ok{color:#9cffbd}
    .warn{color:#ffd27a}
    .err{color:#ff9b9b}
    .right{margin-left:auto}
    .count{font-size:12px;color:#c7cbff}
    details.debug{margin-top:8px}
    details.debug summary{cursor:pointer;color:#9aa0ff}
    pre{background:#0e1324;border:1px solid #20263e;border-radius:10px;padding:10px;max-height:240px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <h1>Amministrazione</h1>
    <span class="badge">Carte usate</span>
    <div class="right status" id="status">Verifica accesso…</div>
  </header>

  <main>
    <section class="panel">
      <div id="authbar" class="status">Controllo login…</div>

      <div class="tabs" id="tabs">
        <button class="tab active" data-kind="creature">Creature</button>
        <button class="tab" data-kind="incantesimo">Incantesimo</button>
        <button class="tab" data-kind="istantanea">Istantanea</button>
        <span class="count" id="count"></span>
      </div>

      <div class="filters">
        <label>Utente
          <input id="f-user" placeholder="login utente" disabled>
        </label>
        <label>Carta
          <input id="f-item" placeholder="nome carta" disabled>
        </label>
        <label>Stato
          <select id="f-status" disabled>
            <option value="all">Tutte</option>
            <option value="pending">Da fare</option>
            <option value="done">Fatto</option>
          </select>
        </label>
        <label>Dal
          <input id="f-from" type="datetime-local" disabled>
        </label>
        <label>Al
          <input id="f-to" type="datetime-local" disabled>
        </label>
        <label>Limite
          <input id="f-limit" type="number" value="100" min="1" max="500" disabled>
        </label>
        <label>Endpoint (facoltativo)
          <input id="f-endpoint" placeholder="/admin/used-cards" disabled>
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="actions">
          <button id="btn-load" disabled>Cerca</button>
          <button id="btn-export" disabled>Esporta CSV</button>
          <button id="btn-clear" disabled>Pulisci filtri</button>
          <button id="btn-auto" disabled>Auto refresh: OFF</button>
        </div>
        <div class="right">
          <button id="btn-mark-selected" disabled>Segna selezionati come FATTO</button>
        </div>
      </div>

      <details class="debug">
        <summary>Debug: mostra il JSON grezzo (primi 3 record)</summary>
        <pre id="dump">(vuoto)</pre>
      </details>
    </section>

    <section class="panel table">
      <table>
        <thead>
          <tr>
            <th style="width:38px"><input type="checkbox" id="chk-all" disabled></th>
            <th style="width:130px">Quando</th>
            <th style="width:160px">Utente</th>
            <th>Carta</th>
            <th style="width:110px">Tipo</th>
            <th style="width:110px">Stato</th>
            <th style="width:140px">Item ID</th>
            <th style="width:160px">Event ID</th>
            <th style="width:120px">Azione</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="9" class="muted">Nessun dato</td></tr>
        </tbody>
      </table>
    </section>
  </main>

<script>
/* ===== CONFIG ===== */
const API_BASE    = 'https://api.malgax.com';
const ME_ENDPOINT = '/me';
const ADMIN_LOGIN = 'malgax';

const LIST_ENDPOINT_DEFAULT  = '/admin/used-cards';          // GET lista
const TOGGLE_DONE_ENDPOINT   = '/admin/used-cards/complete'; // POST {id, done}

/* ===== STATO ===== */
let isAdmin=false, autoTimer=null, dataCache=[], currentKind='creature';

/* ===== DOM ===== */
const $=s=>document.querySelector(s);
const status=$('#status'),authbar=$('#authbar'),count=$('#count'),dump=$('#dump');
const tabs=$('#tabs');
const fUser=$('#f-user'),fItem=$('#f-item'),fStatus=$('#f-status'),
      fFrom=$('#f-from'),fTo=$('#f-to'),fLimit=$('#f-limit'),fEndpoint=$('#f-endpoint');
const btnLoad=$('#btn-load'),btnExport=$('#btn-export'),btnClear=$('#btn-clear'),
      btnAuto=$('#btn-auto'),btnMarkSel=$('#btn-mark-selected');
const rows=$('#rows'),chkAll=$('#chk-all');

/* ===== UTILS ===== */
const toast=(m,c='')=>status.innerHTML=`<span class="${c}">${m}</span>`;
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const fmt=iso=>{ if(!iso)return ''; const d=new Date(iso); return isNaN(d)?String(iso):d.toLocaleString(); };
function setEnabled(on){
  [fUser,fItem,fStatus,fFrom,fTo,fLimit,fEndpoint,btnLoad,btnExport,btnClear,btnAuto,btnMarkSel,chkAll].forEach(el=>el.disabled=!on);
}
/* pick(obj, ['a','b','c'], fallback) — prende il primo campo disponibile */
function pick(o, keys, fb=''){ for(const k of keys){ if(o && o[k]!=null) return o[k]; } return fb; }
/* lowercase safe */
const lower = v => (v==null?'':String(v)).toLowerCase();

/* ===== AUTH ===== */
const AUTH_LOGIN_URL  = API_BASE + '/auth/twitch?return_to=' + encodeURIComponent(location.href);
const AUTH_LOGOUT_URL = API_BASE + '/logout?return_to='     + encodeURIComponent(location.href);
const getLogin = me => lower(me?.login || me?.username || me?.name || me?.display_name || me?.user?.login || me?.data?.user?.login);

async function checkMe(){
  try{
    const res=await fetch(API_BASE+ME_ENDPOINT,{credentials:'include',cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const me=await res.json();
    const who=getLogin(me);
    if(who){
      authbar.innerHTML=`<span class="status ok">Loggato come ${esc(who)}</span> <button onclick="location.href='${AUTH_LOGOUT_URL}'">Logout</button>`;
      isAdmin = (who===ADMIN_LOGIN);
      setEnabled(isAdmin);
      toast(isAdmin?'Accesso admin OK':'Non autorizzato','ok');
    }else{
      authbar.innerHTML=`<span class="status">Non loggato</span> <button onclick="location.href='${AUTH_LOGIN_URL}'">Login con Twitch</button>`;
      isAdmin=false; setEnabled(false);
      toast('Non loggato','warn');
    }
  }catch{
    authbar.innerHTML=`<span class="status">Non loggato</span> <button onclick="location.href='${AUTH_LOGIN_URL}'">Login con Twitch</button>`;
    isAdmin=false; setEnabled(false);
    toast('Non loggato','warn');
  }
}

/* ===== TABS ===== */
tabs.addEventListener('click', (e)=>{
  const b=e.target.closest('.tab'); if(!b) return;
  tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  b.classList.add('active');
  currentKind = b.dataset.kind; // creature | incantesimo | istantanea
  if(isAdmin) load();
});

/* ===== LOAD ===== */
function buildParams(){
  // NUOVA VERSIONE: non inserisce campi vuoti/undefined
  const p = {
    limit: Number(fLimit.value||100)||100,
    kind: currentKind,
    status: fStatus.value || 'all'
  };
  const user = (fUser.value || '').trim();
  if (user) p.user = user;
  const item = (fItem.value || '').trim();
  if (item) p.item = item;
  if (fFrom.value) p.from = new Date(fFrom.value).toISOString();
  if (fTo.value)   p.to   = new Date(fTo.value).toISOString();
  return p;
}
function currentListUrl(){
  const base = (fEndpoint.value||LIST_ENDPOINT_DEFAULT).trim();
  return (base.startsWith('http')? base : (API_BASE + base));
}
function currentToggleUrl(){
  return API_BASE + TOGGLE_DONE_ENDPOINT;
}

async function load(){
  if(!isAdmin){ toast('Solo malgax può cercare','err'); return; }
  const url = currentListUrl();
  const params = buildParams();
  // Costruzione query string SOLO con valori presenti
  const usp = new URLSearchParams();
  for (const [k,v] of Object.entries(params)) {
    if (v !== undefined && v !== null && String(v).trim() !== '') {
      usp.append(k, String(v));
    }
  }
  const qs = usp.toString();
  try{
    toast('Caricamento…');
    const res=await fetch(url + (qs ? ('?' + qs) : ''), {credentials:'include',cache:'no-store'});
    if(!res.ok){ const t=await res.text(); throw new Error('HTTP '+res.status+' → '+t.slice(0,400)); }
    const data=await res.json();
    dataCache = Array.isArray(data) ? data : (data.items||[]);

    // Debug: mostra i primi 3 record grezzi
    dump.textContent = JSON.stringify(dataCache.slice(0,3), null, 2);

    renderTable(dataCache);
    count.textContent = `(${dataCache.length} record)`;
    toast('OK','ok');
  }catch(e){
    dataCache=[]; renderTable(dataCache);
    count.textContent='';
    dump.textContent='ERRORE: '+e.message;
    toast('Errore: '+e.message,'err');
  }
}

/* ===== RENDER ===== */
function renderTable(items){
  rows.innerHTML='';
  if(!items?.length){
    rows.innerHTML='<tr><td colspan="9" class="muted">Nessun dato</td></tr>';
    return;
  }
  const fr=document.createDocumentFragment();

  for(const r of items){
    // ——— mapping robusto per colonne chiave ———
    const when = pick(r, ['created_at','createdAt','timestamp','time','at','used_at','date']);
    const user = pick(r, ['user_login','username','user','viewer','twitch_login','login','userName','player']);
    const card = pick(r, ['item_name','card_name','name','item','title']);
    const kind = pick(r, ['kind','type','card_type'], currentKind);
    const done = !!pick(r, ['done','completed','is_done','handled'], false);
    const itemId = pick(r, ['item_id','card_id','itemId','cardId','reward_id','rewardId']);
    const eid = pick(r, ['id','event_id','_id','eventId']);

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="rowchk" data-id="\${esc(eid)}" \${done?'disabled':''}></td>
      <td>\${esc(fmt(when))}</td>
      <td>\${esc(user)}</td>
      <td>\${esc(card)}</td>
      <td><span class="pill">\${esc(kind)}</span></td>
      <td>\${done ? '<span class="ok">Fatto</span>' : '<span class="warn">Da fare</span>'}</td>
      <td>\${esc(itemId)}</td>
      <td>\${esc(eid)}</td>
      <td><button class="btn-done" data-id="\${esc(eid)}" \${done?'disabled':''}>Segna fatto</button></td>
    `;
    fr.appendChild(tr);
  }
  rows.appendChild(fr);

  rows.querySelectorAll('button.btn-done').forEach(b=> b.disabled = b.disabled || !isAdmin);
  rows.querySelectorAll('input.rowchk').forEach(c=> c.disabled = c.disabled || !isAdmin);
  chkAll.checked = false;
}

/* ===== TOGGLE DONE ===== */
async function markDoneOne(id){
  try{
    const res=await fetch(currentToggleUrl(),{
      method:'POST',
      credentials:'include',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ id, done:true })
    });
    if(!res.ok){ const t=await res.text(); throw new Error('HTTP '+res.status+' → '+t.slice(0,400)); }
    // aggiorna localmente
    const row=dataCache.find(x=>String(pick(x,['id','event_id','_id','eventId']))===String(id));
    if(row){ if('done'in row) row.done=true; else row.completed=true; }
    renderTable(dataCache);
    toast('Segnato come fatto','ok');
  }catch(e){
    toast('Errore segna fatto: '+e.message,'err');
  }
}
async function markDoneSelected(){
  const ids=[...rows.querySelectorAll('input.rowchk:checked')].map(c=>c.dataset.id);
  if(!ids.length){ toast('Seleziona almeno una riga','warn'); return; }
  for(const id of ids){ await markDoneOne(id); }
}

/* ===== AUTO / EXPORT ===== */
function toggleAuto(){
  if(!isAdmin){ toast('Solo malgax può usare auto refresh','err'); return; }
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; btnAuto.textContent='Auto refresh: OFF'; toast('Auto refresh OFF'); }
  else{ autoTimer=setInterval(()=>load().catch(()=>{}),15000); btnAuto.textContent='Auto refresh: ON (15s)'; toast('Auto refresh ON'); }
}
function exportCSV(){
  if(!isAdmin){ toast('Solo malgax può esportare','err'); return; }
  if(!dataCache?.length){ toast('Niente da esportare','warn'); return; }

  const cols=['when','user','card','kind','done','item_id','event_id'];
  const lines=[cols.join(',')];

  for(const r of dataCache){
    const row=[
      fmt(pick(r,['created_at','createdAt','timestamp','time','at','used_at','date'])),
      pick(r,['user_login','username','user','viewer','twitch_login','login','userName','player']),
      pick(r,['item_name','card_name','name','item','title']),
      pick(r,['kind','type','card_type'], currentKind),
      (pick(r,['done','completed','is_done','handled']) ? 'true' : 'false'),
      pick(r,['item_id','card_id','itemId','cardId','reward_id','rewardId']),
      pick(r,['id','event_id','_id','eventId'])
    ];
    lines.push(row.map(v=>`"\${String(v??'').replaceAll('"','""')}"`).join(','));
  }

  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`used_cards_\${currentKind}_\${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
  a.click(); URL.revokeObjectURL(a.href);
}

/* ===== WIRE ===== */
btnLoad.onclick = ()=>load();
btnExport.onclick=()=>exportCSV();
btnClear.onclick = ()=>{ fUser.value=fItem.value=fFrom.value=fTo.value=''; fStatus.value='all'; };
btnAuto.onclick  = ()=>toggleAuto();
btnMarkSel.onclick = ()=>markDoneSelected();
$('#chk-all').onchange = ()=>{
  rows.querySelectorAll('input.rowchk').forEach(c=>{
    if(!c.disabled) c.checked = chkAll.checked;
  });
};
rows.addEventListener('click', e=>{
  const b=e.target.closest('.btn-done'); if(b){ markDoneOne(b.dataset.id); }
});
[fUser,fItem,fStatus,fFrom,fTo,fLimit,fEndpoint].forEach(el=>{
  el.addEventListener('keydown', e=>{ if(e.key==='Enter' && isAdmin) load(); });
});

/* Avvio */
checkMe();
</script>
</body>
</html>
