<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amministrazione — Carte usate</title>
  <style>
    :root{
      --bg:#0f1117; --panel:#151826; --muted:#9397a1; --text:#e7e9ee; --acc:#5b8cff; --radius:14px;
      --border:#20263e; --panel2:#0e1324;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#12172a,transparent)}
    header h1{font-size:18px;margin:0}
    header .badge{font-size:12px;padding:2px 8px;border:1px solid #3a3f57;border-radius:999px;color:var(--muted)}
    main{padding:18px;display:grid;gap:14px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
    .filters{display:grid;grid-template-columns:repeat(7,minmax(120px,1fr));gap:10px}
    .filters label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    input,select,button{background:var(--panel2);color:var(--text);border:1px solid #2a3150;border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#111733;color:#cfd5ff;cursor:pointer}
    .tab.active{background:#1a2448;border-color:#2a3a7a}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .actions{display:flex;gap:10px}
    .table{overflow:auto;border-radius:12px;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;min-width:1000px;background:var(--panel2)}
    th,td{padding:10px 12px;border-bottom:1px solid #1a1f33;font-size:13px;vertical-align:top}
    th{position:sticky;top:0;background:#111833;text-align:left;z-index:1}
    tr:hover td{background:#0f1731}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #3a3f57;border-radius:999px;font-size:12px;color:#cfd5ff;background:#141b33}
    .status{font-size:12px;color:var(--muted)}
    .ok{color:#9cffbd}
    .warn{color:#ffd27a}
    .err{color:#ff9b9b}
    .right{margin-left:auto}
    .count{font-size:12px;color:#c7cbff}
  </style>
</head>
<body>
  <header>
    <h1>Amministrazione</h1>
    <span class="badge">Carte usate</span>
    <div class="right status" id="status">Verifica accesso…</div>
  </header>

  <main>
    <section class="panel">
      <div id="authbar" class="status">Controllo login…</div>

      <div class="tabs" id="tabs">
        <button class="tab active" data-kind="creature">Creature</button>
        <button class="tab" data-kind="incantesimo">Incantesimo</button>
        <button class="tab" data-kind="istantanea">Istantanea</button>
        <span class="count" id="count"></span>
      </div>

      <div class="filters">
        <label>Utente
          <input id="f-user" placeholder="login utente" disabled>
        </label>
        <label>Carta
          <input id="f-item" placeholder="nome carta" disabled>
        </label>
        <label>Stato
          <select id="f-status" disabled>
            <option value="all">Tutte</option>
            <option value="pending">Da fare</option>
            <option value="done">Fatto</option>
          </select>
        </label>
        <label>Dal
          <input id="f-from" type="datetime-local" disabled>
        </label>
        <label>Al
          <input id="f-to" type="datetime-local" disabled>
        </label>
        <label>Limite
          <input id="f-limit" type="number" value="100" min="1" max="500" disabled>
        </label>
        <label>Endpoint (facoltativo)
          <input id="f-endpoint" placeholder="/admin/used-cards" disabled>
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="actions">
          <button id="btn-load" disabled>Cerca</button>
          <button id="btn-export" disabled>Esporta CSV</button>
          <button id="btn-clear" disabled>Pulisci filtri</button>
          <button id="btn-auto" disabled>Auto refresh: OFF</button>
        </div>
        <div class="right">
          <button id="btn-mark-selected" disabled>Segna selezionati come FATTO</button>
        </div>
      </div>
    </section>

    <section class="panel table">
      <table>
        <thead>
          <tr>
            <th style="width:38px"><input type="checkbox" id="chk-all" disabled></th>
            <th style="width:110px">Quando</th>
            <th style="width:160px">Utente</th>
            <th>Carta</th>
            <th style="width:110px">Tipo</th>
            <th style="width:110px">Stato</th>
            <th style="width:140px">Item ID</th>
            <th style="width:160px">Event ID</th>
            <th style="width:120px">Azione</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="9" class="muted">Nessun dato</td></tr>
        </tbody>
      </table>
    </section>
  </main>

<script>
/* ===== CONFIG ===== */
const API_BASE    = 'https://api.malgax.com';
const ME_ENDPOINT = '/me';
const ADMIN_LOGIN = 'malgax';

// Endpoints backend (modificabili se usi percorsi diversi)
const LIST_ENDPOINT_DEFAULT  = '/admin/used-cards';          // GET lista
const TOGGLE_DONE_ENDPOINT   = '/admin/used-cards/complete'; // POST {id, done}

/* ===== STATO ===== */
let isAdmin=false, autoTimer=null, dataCache=[], currentKind='creature';

/* ===== DOM ===== */
const $=s=>document.querySelector(s);
const status=$('#status'),authbar=$('#authbar'),count=$('#count');
const tabs=$('#tabs');
const fUser=$('#f-user'),fItem=$('#f-item'),fStatus=$('#f-status'),
      fFrom=$('#f-from'),fTo=$('#f-to'),fLimit=$('#f-limit'),fEndpoint=$('#f-endpoint');
const btnLoad=$('#btn-load'),btnExport=$('#btn-export'),btnClear=$('#btn-clear'),
      btnAuto=$('#btn-auto'),btnMarkSel=$('#btn-mark-selected');
const rows=$('#rows'),chkAll=$('#chk-all');

/* ===== UTILS ===== */
const toast=(m,c='')=>status.innerHTML=`<span class="${c}">${m}</span>`;
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const fmt=iso=>{ if(!iso)return ''; const d=new Date(iso); return isNaN(d)?String(iso):d.toLocaleString(); };
function setEnabled(on){
  [fUser,fItem,fStatus,fFrom,fTo,fLimit,fEndpoint,btnLoad,btnExport,btnClear,btnAuto,btnMarkSel,chkAll].forEach(el=>el.disabled=!on);
}

/* ===== AUTH ===== */
const AUTH_LOGIN_URL  = API_BASE + '/auth/twitch?return_to=' + encodeURIComponent(location.href);
const AUTH_LOGOUT_URL = API_BASE + '/logout?return_to='     + encodeURIComponent(location.href);
const getLogin = me => (me?.login || me?.username || me?.name || me?.display_name || '').toString().toLowerCase();

async function checkMe(){
  try{
    const res=await fetch(API_BASE+ME_ENDPOINT,{credentials:'include',cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const me=await res.json();
    const who=getLogin(me);
    if(who){
      authbar.innerHTML=`<span class="status ok">Loggato come ${esc(who)}</span> <button onclick="location.href='${AUTH_LOGOUT_URL}'">Logout</button>`;
      isAdmin = (who===ADMIN_LOGIN);
      setEnabled(isAdmin);
      toast(isAdmin?'Accesso admin OK':'Non autorizzato','ok');
    }else{
      authbar.innerHTML=`<span class="status">Non loggato</span> <button onclick="location.href='${AUTH_LOGIN_URL}'">Login con Twitch</button>`;
      isAdmin=false; setEnabled(false);
      toast('Non loggato','warn');
    }
  }catch{
    authbar.innerHTML=`<span class="status">Non loggato</span> <button onclick="location.href='${AUTH_LOGIN_URL}'">Login con Twitch</button>`;
    isAdmin=false; setEnabled(false);
    toast('Non loggato','warn');
  }
}

/* ===== TABS ===== */
tabs.addEventListener('click', (e)=>{
  const b=e.target.closest('.tab'); if(!b) return;
  tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  b.classList.add('active');
  currentKind = b.dataset.kind; // creature | incantesimo | istantanea
  if(isAdmin) load();
});

/* ===== LOAD ===== */
function buildParams(){
  return {
    limit: Number(fLimit.value||100)||100,
    kind: currentKind,            // filtro per tab
    status: fStatus.value||'all', // all | pending | done
    user: (fUser.value||'').trim()||undefined,
    item: (fItem.value||'').trim()||undefined,
    from: fFrom.value ? new Date(fFrom.value).toISOString() : undefined,
    to:   fTo.value   ? new Date(fTo.value).toISOString()   : undefined
  };
}
function currentListUrl(){
  const base = (fEndpoint.value||LIST_ENDPOINT_DEFAULT).trim();
  return (base.startsWith('http')? base : (API_BASE + base));
}
function currentToggleUrl(){
  return API_BASE + TOGGLE_DONE_ENDPOINT;
}

async function load(){
  if(!isAdmin){ toast('Solo malgax può cercare','err'); return; }
  const url = currentListUrl();
  const qs  = new URLSearchParams(buildParams()).toString();
  try{
    toast('Caricamento…');
    const res=await fetch(url+'?'+qs,{credentials:'include',cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json();
    dataCache = Array.isArray(data) ? data : (data.items||[]);
    renderTable(dataCache);
    count.textContent = `(${dataCache.length} record)`;
    toast('OK','ok');
  }catch(e){
    dataCache=[]; renderTable(dataCache);
    count.textContent='';
    toast('Errore: '+e.message,'err');
  }
}

/* ===== RENDER ===== */
function renderTable(items){
  rows.innerHTML='';
  if(!items?.length){
    rows.innerHTML='<tr><td colspan="9" class="muted">Nessun dato</td></tr>';
    return;
  }
  const fr=document.createDocumentFragment();
  for(const r of items){
    const tr=document.createElement('tr');
    const done = !!(r.done || r.completed || r.is_done);
    tr.innerHTML = `
      <td><input type="checkbox" class="rowchk" data-id="${esc(r.id)}" ${done?'disabled':''}></td>
      <td>${esc(fmt(r.created_at))}</td>
      <td>${esc(r.user_login||'')}</td>
      <td>${esc(r.item_name||'')}</td>
      <td><span class="pill">${esc(r.kind||currentKind)}</span></td>
      <td>${done ? '<span class="ok">Fatto</span>' : '<span class="warn">Da fare</span>'}</td>
      <td>${esc(r.item_id||'')}</td>
      <td>${esc(r.id||'')}</td>
      <td>
        <button class="btn-done" data-id="${esc(r.id)}" ${done?'disabled':''}>Segna fatto</button>
      </td>
    `;
    fr.appendChild(tr);
  }
  rows.appendChild(fr);
  // abilita pulsanti in base allo stato admin
  rows.querySelectorAll('button.btn-done').forEach(b=> b.disabled = b.disabled || !isAdmin);
  rows.querySelectorAll('input.rowchk').forEach(c=> c.disabled = c.disabled || !isAdmin);
  chkAll.checked = false;
}

/* ===== TOGGLE DONE ===== */
async function markDoneOne(id){
  try{
    const res=await fetch(currentToggleUrl(),{
      method:'POST',
      credentials:'include',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ id, done:true })
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    // Aggiorna localmente
    const row=dataCache.find(x=>String(x.id)===String(id));
    if(row){ row.done=true; }
    renderTable(dataCache);
    toast('Segnato come fatto','ok');
  }catch(e){
    toast('Errore segna fatto: '+e.message,'err');
  }
}
async function markDoneSelected(){
  const ids=[...rows.querySelectorAll('input.rowchk:checked')].map(c=>c.dataset.id);
  if(!ids.length){ toast('Seleziona almeno una riga','warn'); return; }
  // invii sequenziali semplici; se vuoi, si può ottimizzare in batch lato server
  for(const id of ids){ await markDoneOne(id); }
}

/* ===== AUTO REFRESH ===== */
function toggleAuto(){
  if(!isAdmin){ toast('Solo malgax può usare auto refresh','err'); return; }
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; btnAuto.textContent='Auto refresh: OFF'; toast('Auto refresh OFF'); }
  else{ autoTimer=setInterval(()=>load().catch(()=>{}),15000); btnAuto.textContent='Auto refresh: ON (15s)'; toast('Auto refresh ON'); }
}

/* ===== EXPORT ===== */
function exportCSV(){
  if(!isAdmin){ toast('Solo malgax può esportare','err'); return; }
  if(!dataCache?.length){ toast('Niente da esportare','warn'); return; }
  const cols=['created_at','user_login','item_name','kind','done','item_id','id'];
  const lines=[cols.join(',')];
  for(const r of dataCache){
    const row=[r.created_at, r.user_login, r.item_name, (r.kind||currentKind), (r.done||r.completed||r.is_done)?'true':'false', r.item_id, r.id];
    lines.push(row.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(','));
  }
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`used_cards_${currentKind}_${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
  a.click(); URL.revokeObjectURL(a.href);
}

/* ===== WIRE ===== */
btnLoad.onclick = ()=>load();
btnExport.onclick=()=>exportCSV();
btnClear.onclick = ()=>{ fUser.value=fItem.value=fFrom.value=fTo.value=''; fStatus.value='all'; };
btnAuto.onclick  = ()=>toggleAuto();
btnMarkSel.onclick = ()=>markDoneSelected();
chkAll.onchange = ()=>{
  rows.querySelectorAll('input.rowchk').forEach(c=>{
    if(!c.disabled) c.checked = chkAll.checked;
  });
};
rows.addEventListener('click', e=>{
  const b=e.target.closest('.btn-done'); if(b){ markDoneOne(b.dataset.id); }
});
[fUser,fItem,fStatus,fFrom,fTo,fLimit,fEndpoint].forEach(el=>{
  el.addEventListener('keydown', e=>{ if(e.key==='Enter' && isAdmin) load(); });
});

/* Avvio */
checkMe();
</script>
</body>
</html>
